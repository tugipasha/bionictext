<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>BionicText | Kitap Dönüştürücü</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bionic-weight: 700;
            --primary-color: #4f46e5;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Themes */
        body.theme-light { background-color: #f8fafc; color: #1e293b; }
        body.theme-dark { background-color: #1a1a1a !important; color: #ffffff !important; }
        body.theme-dark .bg-white { background-color: #2a2a2a !important; color: #ffffff !important; }
        body.theme-dark .bg-slate-100 { background-color: #334155 !important; }
        body.theme-dark .bg-slate-50 { background-color: #1f2937 !important; }
        body.theme-dark .text-slate-900, body.theme-dark .text-slate-800, body.theme-dark .text-slate-700 { color: #f3f4f6 !important; }
        body.theme-dark .text-slate-600, body.theme-dark .text-slate-500 { color: #d1d5db !important; }
        body.theme-dark .border-slate-200, body.theme-dark .border-slate-300 { border-color: #374151 !important; }
        body.theme-dark #navbar { background-color: rgba(26, 26, 26, 0.8) !important; border-color: #374151 !important; }
        body.theme-dark #controlPanel, body.theme-dark #output { background-color: #2a2a2a !important; border-color: #374151 !important; }

        body.theme-sepia { background-color: #f4ecd8 !important; color: #5c4a3a !important; }
        body.theme-sepia .bg-white { background-color: #fdf6e3 !important; color: #5c4a3a !important; }
        body.theme-sepia .bg-slate-100 { background-color: #eee8d5 !important; }
        body.theme-sepia .bg-slate-50 { background-color: #eee8d5 !important; }
        body.theme-sepia .text-slate-900, body.theme-sepia .text-slate-800, body.theme-sepia .text-slate-700 { color: #5c4a3a !important; }
        body.theme-sepia .text-slate-600, body.theme-sepia .text-slate-500 { color: #839496 !important; }
        body.theme-sepia .border-slate-200, body.theme-sepia .border-slate-300 { border-color: #d5be9a !important; }
        body.theme-sepia #navbar { background-color: rgba(244, 236, 216, 0.8) !important; border-color: #d5be9a !important; }
        body.theme-sepia #controlPanel, body.theme-sepia #output { background-color: #fdf6e3 !important; border-color: #d5be9a !important; }

        .bold { font-weight: var(--bionic-weight); }

        #output p { margin-bottom: 1.5rem; text-align: justify; }

        /* Hide elements on print */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; padding: 0 !important; }
            #output { font-size: 12pt !important; line-height: 1.6 !important; }
            .container { max-width: none !important; width: 100% !important; box-shadow: none !important; padding: 0 !important; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="light min-h-screen">

    <!-- Navigation -->
    <nav class="no-print border-b bg-white/80 backdrop-blur-md sticky top-0 z-40 transition-colors duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-4">
                    <a href="./index.html" class="flex items-center gap-2 text-indigo-600 font-bold text-xl">
                        <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <span class="hidden sm:inline">BionicText</span>
                    </a>
                </div>

                <div class="flex items-center gap-3 sm:gap-6">
                    <!-- Language Selector -->
                    <select id="langSelect" onchange="changeLanguage(this.value)" class="bg-transparent border-none text-sm font-medium focus:ring-0 cursor-pointer">
                        <option value="tr">TR</option>
                        <option value="en">EN</option>
                        <option value="it">IT</option>
                    </select>

                    <!-- Theme Selector -->
                    <div class="flex bg-slate-100 rounded-lg p-1 gap-1">
                        <button onclick="setTheme('light')" class="p-1.5 rounded-md hover:bg-white transition-colors" title="Light">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 5a7 7 0 100 14 7 7 0 000-14z"/></svg>
                        </button>
                        <button onclick="setTheme('dark')" class="p-1.5 rounded-md hover:bg-white transition-colors" title="Dark">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                        </button>
                        <button onclick="setTheme('sepia')" class="p-1.5 rounded-md hover:bg-white transition-colors" title="Sepia">
                            <span class="text-xs font-bold px-0.5">S</span>
                        </button>
                    </div>

                    <!-- User Profile -->
                    <div id="userProfile" class="hidden relative group">
                        <button class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold" id="userInitial">U</div>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 py-2">
                            <a href="./index.html#profile" class="block px-4 py-2 hover:bg-slate-50 text-sm" data-i18n="profile_menu_profile">Profilim</a>
                            <button onclick="logout()" class="w-full text-left px-4 py-2 hover:bg-slate-50 text-sm text-red-600" data-i18n="profile_menu_logout">Çıkış Yap</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-8 sm:py-12">
        <!-- Header Section -->
        <div class="text-center mb-12 no-print">
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight mb-4" data-i18n="book_converter_title">Biyonik PDF Okuyucu</h1>
            <p class="text-slate-500 max-w-2xl mx-auto" data-i18n="book_converter_subtitle">PDF kitaplarınızı biyonik formata dönüştürerek daha hızlı okuyun ve anlayın.</p>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sm:p-8 mb-8 no-print transition-colors duration-300" id="controlPanel">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- File Upload -->
                <div class="space-y-4">
                    <label class="block text-sm font-semibold text-slate-700 mb-2" data-i18n="converter_file_upload">PDF Dosyası Seç</label>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:border-indigo-500 hover:bg-indigo-50/50 transition-all group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 text-slate-400 group-hover:text-indigo-500 mb-2 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-sm text-slate-500 group-hover:text-indigo-600 transition-colors font-medium" id="fileName" data-i18n="converter_choose_file">Dosya Seçin</p>
                        </div>
                        <input type="file" id="fileInput" class="hidden" accept="application/pdf" />
                    </label>
                </div>

                <!-- Settings -->
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold text-slate-700" data-i18n="settings_bold_intensity">Odaklanma Oranı</label>
                            <span id="ratioVal" class="text-sm font-bold text-indigo-600">50%</span>
                        </div>
                        <input type="range" id="ratio" min="0.3" max="0.7" step="0.1" value="0.5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold text-slate-700" data-i18n="settings_bold_intensity">Kalınlık Seviyesi</label>
                            <span id="weightVal" class="text-sm font-bold text-indigo-600">700</span>
                        </div>
                        <input type="range" id="weight" min="500" max="900" step="100" value="700" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    </div>
                </div>
            </div>

            <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center items-center">
                <button onclick="printPDF()" id="printBtn" class="w-full sm:w-auto px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                    <span data-i18n="test_download_report">PDF Kaydet / Yazdır</span>
                </button>
            </div>
            <p class="text-center text-xs text-slate-400 mt-4" data-i18n="print_note">Not: Hedef olarak "PDF Olarak Kaydet" seçeneğini kullanın.</p>
        </div>

        <!-- Output Area -->
        <div id="loading" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent mb-4"></div>
            <p class="text-slate-500 font-medium" data-i18n="notif_processing">Dönüştürülüyor, lütfen bekleyin...</p>
        </div>

        <div id="output" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 sm:p-12 min-h-[400px] transition-colors duration-300 prose max-w-none">
            <div class="flex flex-col items-center justify-center text-slate-400 mt-20 text-center">
                <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <p data-i18n="no_file_uploaded">Henüz bir dosya yüklenmedi.</p>
            </div>
        </div>
    </main>

    <script>
        // --- TRANSLATIONS ---
        const translations = {
            tr: {
                book_converter_title: "Biyonik PDF Okuyucu",
                book_converter_subtitle: "PDF kitaplarınızı biyonik formata dönüştürerek daha hızlı okuyun.",
                converter_file_upload: "PDF Dosyası Seç",
                converter_choose_file: "Dosya Seçin",
                settings_bold_intensity: "Odaklanma Oranı",
                test_download_report: "PDF Kaydet / Yazdır",
                print_note: "Not: Hedef olarak \"PDF Olarak Kaydet\" seçeneğini kullanın.",
                notif_processing: "Dönüştürülüyor, lütfen bekleyin...",
                no_file_uploaded: "Henüz bir dosya yüklenmedi.",
                profile_menu_profile: "Profilim",
                profile_menu_logout: "Çıkış Yap",
                error_reading_pdf: "PDF okunurken hata oluştu: "
            },
            en: {
                book_converter_title: "Bionic PDF Reader",
                book_converter_subtitle: "Read faster by converting your PDF books to bionic format.",
                converter_file_upload: "Select PDF File",
                converter_choose_file: "Choose File",
                settings_bold_intensity: "Focus Ratio",
                test_download_report: "Save as PDF / Print",
                print_note: "Note: Choose \"Save as PDF\" as the destination.",
                notif_processing: "Converting, please wait...",
                no_file_uploaded: "No file uploaded yet.",
                profile_menu_profile: "My Profile",
                profile_menu_logout: "Logout",
                error_reading_pdf: "Error reading PDF: "
            },
            it: {
                book_converter_title: "Lettore PDF Bionico",
                book_converter_subtitle: "Leggi più velocemente convertendo i tuoi libri PDF in formato bionico.",
                converter_file_upload: "Seleziona file PDF",
                converter_choose_file: "Scegli file",
                settings_bold_intensity: "Rapporto di messa a fuoco",
                test_download_report: "Salva come PDF / Stampa",
                print_note: "Nota: Scegli \"Salva come PDF\" come destinazione.",
                notif_processing: "Conversione in corso, attendere...",
                no_file_uploaded: "Nessun file caricato.",
                profile_menu_profile: "Il mio profilo",
                profile_menu_logout: "Esci",
                error_reading_pdf: "Errore durante la lettura del PDF: "
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'tr';

        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
            document.getElementById('langSelect').value = currentLanguage;
            document.documentElement.lang = currentLanguage;
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            applyLanguage();
            if (rawText) renderText();
        }

        // --- THEMES ---
        function setTheme(theme) {
            document.body.classList.remove('theme-light', 'theme-dark', 'theme-sepia');
            document.body.classList.add('theme-' + theme);
            localStorage.setItem('theme', theme);
            
            // Update theme button highlights
            const themeButtons = document.querySelectorAll('[onclick^="setTheme"]');
            themeButtons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${theme}'`)) {
                    btn.classList.add('bg-indigo-100', 'text-indigo-600');
                    btn.classList.remove('hover:bg-white');
                } else {
                    btn.classList.remove('bg-indigo-100', 'text-indigo-600');
                    btn.classList.add('hover:bg-white');
                }
            });
        }

        // --- AUTH ---
        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user) {
                document.getElementById('userProfile').classList.remove('hidden');
                document.getElementById('userInitial').textContent = user.name ? user.name[0].toUpperCase() : user.email[0].toUpperCase();
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = './index.html';
        }

        // --- PDF LOGIC ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        let rawText = "";
        const fileInput = document.getElementById('fileInput');
        const ratioInput = document.getElementById('ratio');
        const weightInput = document.getElementById('weight');
        const outputDiv = document.getElementById('output');
        const loadingDiv = document.getElementById('loading');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;
            outputDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = "";

                    const totalPages = pdf.numPages;
                    for (let i = 1; i <= totalPages; i++) {
                        // Update loading progress
                        const msg = currentLanguage === 'tr' ? `Dönüştürülüyor: Sayfa ${i} / ${totalPages}` : 
                                    currentLanguage === 'it' ? `Conversione: Pagina ${i} / ${totalPages}` : 
                                    `Converting: Page ${i} / ${totalPages}`;
                        loadingDiv.querySelector('p').textContent = msg;

                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const pageText = content.items.map(item => item.str).join(" ");
                        fullText += `<p>${pageText}</p>`;
                    }

                    rawText = fullText;
                    renderText();
                    loadingDiv.classList.add('hidden');
                    outputDiv.classList.remove('hidden');
                } catch (err) {
                    alert(translations[currentLanguage].error_reading_pdf + err.message);
                    loadingDiv.classList.add('hidden');
                    outputDiv.classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        ratioInput.addEventListener('input', () => {
            document.getElementById('ratioVal').textContent = Math.round(ratioInput.value * 100) + "%";
            if(rawText) renderText();
        });

        weightInput.addEventListener('input', () => {
            const val = weightInput.value;
            document.getElementById('weightVal').textContent = val;
            document.documentElement.style.setProperty('--bionic-weight', val);
        });

        function renderText() {
            if (!rawText) return;
            const ratio = parseFloat(ratioInput.value);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rawText;
            processNode(tempDiv, ratio);
            outputDiv.innerHTML = tempDiv.innerHTML;
        }

        function processNode(node, ratio) {
            if (node.nodeType === 3) {
                const text = node.nodeValue;
                if (!text.trim()) return;
                const newHtml = text.split(/(\s+)/).map(word => {
                    if (!word.trim()) return word;
                    const len = Math.ceil(word.length * ratio);
                    return `<span class="bold">${word.slice(0, len)}</span>${word.slice(len)}`;
                }).join('');
                const span = document.createElement('span');
                span.innerHTML = newHtml;
                node.replaceWith(span);
            } else {
                node.childNodes.forEach(child => processNode(child, ratio));
            }
        }

        function printPDF() {
            if(!rawText) return;
            window.print();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            applyLanguage();
            checkAuth();
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        });
    </script>
</body>
</html>
